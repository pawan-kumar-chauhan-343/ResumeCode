<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resume Filter</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/5.1.0/tesseract.min.js"></script>
    <style>
        #loading, #error { display: none; }
        #error { color: red; }
        #progress-bar { width: 0; background: blue; height: 10px; }
        div { margin: 10px 0; }
    </style>
</head>
<body>
    <h1>Resume Filter</h1>
    <div>
        <label>Skills (comma-separated, any match): <input type="text" id="skills" placeholder="JavaScript, Python"></label>
        <label>Mandatory Skills (all must match): <input type="text" id="mandatory-skills" placeholder="AutoCAD"></label>
        <label>Min Experience (years): <input type="number" id="experience" placeholder="1" min="0"></label>
        <label>Upload Resumes (PDFs): <input type="file" id="resumes" accept=".pdf" multiple></label>
        <button id="filter-button">Filter Resumes</button>
        <div id="loading">Processing... <div id="progress-bar"></div><span id="progress-percentage">0%</span></div>
        <div id="error"></div>
        <div id="download-buttons" style="display: none;">
            <button id="download-selected" disabled>Download Selected</button>
        </div>
        <div id="results"></div>
    </div>
    <script>
        // Suppress pdf.js warnings
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
        pdfjsLib.verbosity = pdfjsLib.VerbosityLevel.ERRORS; // Limit to errors only

        const API_KEY = 'AIzaSyAyPHi-G2HuYLYzyAm6vowjUoAsyeBpaMw';
        const API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent';

        async function extractTextFromPDF(file) {
            try {
                const pdf = await pdfjsLib.getDocument({ data: await file.arrayBuffer() }).promise;
                let text = '';
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const content = await page.getTextContent();
                    text += content.items.map(item => item.str).join(' ') + ' ';
                }
                text = text.trim();
                if (text.length < 50 || !/[a-zA-Z]{10}/.test(text)) { // Check for meaningful text
                    text = await extractTextFromPDFImages(pdf, file.name);
                }
                if (!text) throw new Error(`No text extracted from ${file.name}`);
                return text;
            } catch (error) {
                throw new Error(`PDF processing failed: ${error.message}`);
            }
        }

        async function extractTextFromPDFImages(pdf, fileName) {
            let text = '';
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const viewport = page.getViewport({ scale: 2.0 });
                const canvas = document.createElement('canvas');
                canvas.height = viewport.height;
                canvas.width = viewport.width;
                await page.render({ canvasContext: canvas.getContext('2d'), viewport }).promise;
                const { data: { text: ocrText } } = await Tesseract.recognize(canvas, 'eng');
                text += ocrText + ' ';
                canvas.remove();
            }
            return text.trim();
        }

        async function analyzeResume(resumeText, skills, mandatorySkills, minExperience) {
            const prompt = `
                Analyze resume. If mandatory skills exist, all must match and experience must meet minimum. Otherwise, at least one required skill must match and meet minimum experience.
                Required skills: ${skills || 'None'}
                Mandatory skills: ${mandatorySkills || 'None'}
                Minimum experience: ${minExperience} years
                Resume: ${resumeText.substring(0, 4000)}...
                Return JSON: { match: boolean, allSkills: string[], missingSkills: string[], experienceYears: number, experienceMonths: number, address: string, previousCompanies: string[], numberOfCompanies: number, lastCompany: string, summary: string }
            `;
            const response = await fetch(`${API_URL}?key=${API_KEY}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });
            if (!response.ok) throw new Error(response.status === 429 ? 'API_LIMIT_EXCEEDED' : `API error: ${await response.json().then(d => d.error?.message || response.statusText)}`);
            const text = (await response.json()).candidates?.[0]?.content?.parts?.[0]?.text;
            return JSON.parse(text.match(/{[\s\S]*}/)[0]);
        }

        async function downloadSelectedResumes() {
            const selected = document.querySelectorAll('.resume-checkbox:checked');
            if (!selected.length) return;
            const zip = new JSZip();
            await Promise.all(Array.from(selected).map(async cb => zip.file(cb.dataset.file, await (await fetch(cb.dataset.url)).blob())));
            saveAs(await zip.generateAsync({ type: 'blob' }), 'selected_resumes.zip');
        }

        async function filterResumes() {
            const skills = document.getElementById('skills').value.trim();
            const mandatorySkills = document.getElementById('mandatory-skills').value.trim();
            const minExperience = parseInt(document.getElementById('experience').value);
            const resumeFiles = document.getElementById('resumes').files;
            const results = document.getElementById('results');
            const error = document.getElementById('error');
            const loading = document.getElementById('loading');
            const downloadButtons = document.getElementById('download-buttons');
            const progressBar = document.getElementById('progress-bar');
            const progressPercentage = document.getElementById('progress-percentage');

            if (!skills && !mandatorySkills || isNaN(minExperience) || !resumeFiles.length) {
                error.textContent = 'Provide skills, experience, and at least one resume.';
                error.style.display = 'block';
                return;
            }

            error.style.display = 'none';
            results.innerHTML = '';
            downloadButtons.style.display = 'none';
            loading.style.display = 'block';

            const matchingResumes = [];
            let processed = 0;
            for (const file of resumeFiles) {
                try {
                    const text = await extractTextFromPDF(file);
                    const analysis = await analyzeResume(text, skills, mandatorySkills, minExperience);
                    if (analysis.match) matchingResumes.push({ file, analysis });
                } catch (error) {
                    if (error.message === 'API_LIMIT_EXCEEDED') {
                        error.textContent = 'API rate limit exceeded. Try again later.';
                        error.style.display = 'block';
                        loading.style.display = 'none';
                        return;
                    }
                }
                processed++;
                progressBar.style.width = `${(processed / resumeFiles.length) * 100}%`;
                progressPercentage.textContent = `${Math.round((processed / resumeFiles.length) * 100)}%`;
            }

            loading.style.display = 'none';
            progressBar.style.width = '0%';
            progressPercentage.textContent = '0%';
            if (!matchingResumes.length) {
                results.innerHTML = '<p>No resumes matched.</p>';
                return;
            }

            downloadButtons.style.display = 'block';
            const fragment = document.createDocumentFragment();
            matchingResumes.forEach(({ file, analysis }) => {
                const url = URL.createObjectURL(new Blob([file], { type: 'application/pdf' }));
                const div = document.createElement('div');
                div.innerHTML = `
                    <input type="checkbox" class="resume-checkbox" data-file="${file.name}" data-url="${url}">
                    <strong>Resume:</strong> ${file.name}<br>
                    <strong>Experience:</strong> ${analysis.experienceYears || 0} years${analysis.experienceMonths ? `, ${analysis.experienceMonths} months` : ''}<br>
                    <strong>Skills:</strong> ${analysis.allSkills?.join(', ') || 'None'}<br>
                    <strong>Missing Skills:</strong> ${analysis.missingSkills?.join(', ') || 'None'}<br>
                    <strong>Address:</strong> ${analysis.address || 'Not specified'}<br>
                    <strong>Companies:</strong> ${analysis.previousCompanies?.join(', ') || 'Not specified'}<br>
                    <strong>Summary:</strong> ${analysis.summary || 'No summary'}
                `;
                fragment.appendChild(div);
            });
            results.appendChild(fragment);

            document.querySelectorAll('.resume-checkbox').forEach(cb => cb.addEventListener('change', () => {
                document.getElementById('download-selected').disabled = !document.querySelectorAll('.resume-checkbox:checked').length;
            }));
            document.getElementById('download-selected').addEventListener('click', downloadSelectedResumes);
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('filter-button').addEventListener('click', filterResumes);
        });
    </script>
</body>
</html>
