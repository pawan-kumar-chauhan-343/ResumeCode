<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resume Filter</title>
    <!-- Bootstrap 5.3 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <!-- PDF.js, JSZip, FileSaver.js, Tesseract.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/5.1.0/tesseract.min.js"></script>
    <style>
        body { background-color: #f8f9fa; }
        .card { border-radius: 10px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); }
        .btn-primary { background-color: #0d6efd; border-color: #0d6efd; }
        .btn-primary:hover { background-color: #0b5ed7; }
        .btn-success { background-color: #198754; border-color: #198754; }
        .btn-success:hover { background-color: #157347; }
        .progress { height: 10px; }
        .progress-bar { background-color: #0d6efd; transition: width 0.3s ease; }
        #results .card { margin-bottom: 1rem; }
        @media (max-width: 576px) {
            h1 { font-size: 1.5rem; }
            .btn { font-size: 0.9rem; }
        }
    </style>
</head>
<body>
    <div class="container py-4">
        <h1 class="text-center mb-4">Resume Filter</h1>
        <div class="card p-4">
            <div class="row g-3">
                <div class="col-12 col-md-6">
                    <label for="skills" class="form-label">Skills (comma-separated, any match)</label>
                    <input type="text" class="form-control" id="skills" placeholder="JavaScript, Python">
                </div>
                <div class="col-12 col-md-6">
                    <label for="mandatory-skills" class="form-label">Mandatory Skills (all must match)</label>
                    <input type="text" class="form-control" id="mandatory-skills" placeholder="AutoCAD">
                </div>
                <div class="col-12 col-md-6">
                    <label for="experience" class="form-label">Min Experience (years)</label>
                    <input type="number" class="form-control" id="experience" placeholder="1" min="0">
                </div>
                <div class="col-12 col-md-6">
                    <label for="resumes" class="form-label">Upload Resumes (PDFs)</label>
                    <input type="file" class="form-control" id="resumes" accept=".pdf" multiple>
                </div>
                <div class="col-12 text-center">
                    <button id="filter-button" class="btn btn-primary">Filter Resumes</button>
                </div>
            </div>
            <div id="loading" class="mt-3 d-none">
                <span>Processing...</span>
                <div class="progress">
                    <div id="progress-bar" class="progress-bar" style="width: 0;"></div>
                </div>
                <span id="progress-percentage">0%</span>
            </div>
            <div id="error" class="alert alert-danger mt-3 d-none"></div>
            <div id="download-buttons" class="mt-3 text-center d-none">
                <button id="download-selected" class="btn btn-success" disabled>Download Selected</button>
            </div>
        </div>
        <div id="results" class="mt-4"></div>
    </div>
    <!-- Bootstrap 5.3 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script>
        // Configure pdf.js worker and suppress warnings
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
        pdfjsLib.verbosity = pdfjsLib.VerbosityLevel.ERRORS;

        const API_KEY = 'Your-Gemini-API-KEY';
        const API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent';

        async function extractFromPDF(file) {
            try {
                const pdf = await pdfjsLib.getDocument({ data: await file.arrayBuffer() }).promise;
                let text = '';
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const content = await page.getTextContent();
                    text += content.items.map(item => item.str).join(' ') + ' ';
                }
                text = text.trim();
                if (text.length < 50 || !/[a-zA-Z]{10}/.test(text)) {
                    text = await extractFromPDFImages(pdf, file.name);
                }
                if (!text) throw new Error(`No text extracted from ${file.name}`);
                return text;
            } catch (error) {
                throw new Error(`PDF processing failed: ${error.message}`);
            }
        }

        async function extractFromPDFImages(pdf, fileName) {
            let text = '';
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const viewport = page.getViewport({ scale: 2.0 });
                const canvas = document.createElement('canvas');
                canvas.height = viewport.height;
                canvas.width = viewport.width;
                await page.render({ canvasContext: canvas.getContext('2d'), viewport }).promise;
                const { data: { text: ocrText } } = await Tesseract.recognize(canvas, 'eng');
                text += ocrText + ' ';
                canvas.remove();
            }
            return text.trim();
        }

        async function analyzeResume(resumeText, skills, mandatorySkills, minExperience) {
            const prompt = `
                Analyze resume. If mandatory skills exist, all must match and experience must meet minimum. Otherwise, at least one required skill must match and meet minimum experience.
                Required skills: ${skills || 'None'}
                Mandatory skills: ${mandatorySkills || 'None'}
                Minimum experience: ${minExperience} years
                Resume: ${resumeText.substring(0, 4000)}...
                Return JSON: { match: boolean, allSkills: string[], missingSkills: string[], experienceYears: number, experienceMonths: number, address: string, previousCompanies: string[], numberOfCompanies: number, lastCompany: string, summary: string }
            `;
            const response = await fetch(`${API_URL}?key=${API_KEY}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });
            if (!response.ok) throw new Error(response.status === 429 ? 'API_LIMIT_EXCEEDED' : `API error: ${await response.json().then(d => d.error?.message || response.statusText)}`);
            const text = (await response.json()).candidates?.[0]?.content?.parts?.[0]?.text;
            return JSON.parse(text.match(/{[\s\S]*}/)[0]);
        }

        async function downloadSelectedResumes() {
            const selected = document.querySelectorAll('.resume-checkbox:checked');
            if (!selected.length) return;
            const zip = new JSZip();
            await Promise.all(Array.from(selected).map(async cb => zip.file(cb.dataset.file, await (await fetch(cb.dataset.url)).blob())));
            saveAs(await zip.generateAsync({ type: 'blob' }), 'selected_resumes.zip');
        }

        async function filterResumes() {
            const skills = document.getElementById('skills').value.trim();
            const mandatorySkills = document.getElementById('mandatory-skills').value.trim();
            const minExperience = parseInt(document.getElementById('experience').value);
            const resumeFiles = document.getElementById('resumes').files;
            const results = document.getElementById('results');
            const error = document.getElementById('error');
            const loading = document.getElementById('loading');
            const downloadButtons = document.getElementById('download-buttons');
            const progressBar = document.getElementById('progress-bar');
            const progressPercentage = document.getElementById('progress-percentage');

            if (!skills && !mandatorySkills || isNaN(minExperience) || !resumeFiles.length) {
                error.textContent = 'Provide skills, experience, and at least one resume.';
                error.classList.add('show');
                error.classList.remove('d-none');
                return;
            }

            error.classList.add('d-none');
            error.classList.remove('show');
            results.innerHTML = '';
            downloadButtons.classList.add('d-none');
            loading.classList.remove('d-none');

            const matchingResumes = [];
            let processed = 0;
            for (const file of resumeFiles) {
                try {
                    const text = await extractFromPDF(file);
                    const analysis = await analyzeResume(text, skills, mandatorySkills, minExperience);
                    if (analysis.match) matchingResumes.push({ file, analysis });
                } catch (error) {
                    if (error.message === 'API_LIMIT_EXCEEDED') {
                        error.textContent = 'API rate limit exceeded. Try again later.';
                        error.classList.add('show');
                        error.classList.remove('d-none');
                        loading.classList.add('d-none');
                        return;
                    }
                }
                processed++;
                progressBar.style.width = `${(processed / resumeFiles.length) * 100}%`;
                progressPercentage.textContent = `${Math.round((processed / resumeFiles.length) * 100)}%`;
            }

            loading.classList.add('d-none');
            progressBar.style.width = '0%';
            progressPercentage.textContent = '0%';
            if (!matchingResumes.length) {
                results.innerHTML = '<div class="alert alert-warning">No resumes matched.</div>';
                return;
            }

            downloadButtons.classList.remove('d-none');
            const fragment = document.createDocumentFragment();
            matchingResumes.forEach(({ file, analysis }) => {
                const url = URL.createObjectURL(new Blob([file], { type: 'application/pdf' }));
                const div = document.createElement('div');
                div.className = 'card p-3';
                div.innerHTML = `
                    <div class="d-flex align-items-center mb-2">
                        <input type="checkbox" class="resume-checkbox me-2" data-file="${file.name}" data-url="${url}">
                        <strong>Resume:</strong> ${file.name}
                    </div>
                    <p class="mb-1"><strong>Experience:</strong> ${analysis.experienceYears || 0} years${analysis.experienceMonths ? `, ${analysis.experienceMonths} months` : ''}</p>
                    <p class="mb-1"><strong>Skills:</strong> ${analysis.allSkills?.join(', ') || 'None'}</p>
                    <p class="mb-1"><strong>Missing Skills:</strong> ${analysis.missingSkills?.join(', ') || 'None'}</p>
                    <p class="mb-1"><strong>Address:</strong> ${analysis.address || 'Not specified'}</p>
                    <p class="mb-1"><strong>Companies:</strong> ${analysis.previousCompanies?.join(', ') || 'Not specified'}</p>
                    <p class="mb-0"><strong>Summary:</strong> ${analysis.summary || 'No summary'}</p>
                `;
                fragment.appendChild(div);
            });
            results.appendChild(fragment);

            document.querySelectorAll('.resume-checkbox').forEach(cb => cb.addEventListener('change', () => {
                document.getElementById('download-selected').disabled = !document.querySelectorAll('.resume-checkbox:checked').length;
            }));
            document.getElementById('download-selected').addEventListener('click', downloadSelectedResumes);
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('filter-button').addEventListener('click', filterResumes);
        });
    </script>
</body>
</html>
